# ============================================================================
# SUMO Signalized Intersection Simulation - Central Configuration
# ============================================================================
# Phase 2: 4-way signalized intersection with Webster's Method and PPO
# ============================================================================

# --------------------------------------------------------------------------
# Simulation Settings
# --------------------------------------------------------------------------
simulation:
  seed: 42
  horizon: 3600.0             # Total simulation time (seconds) - 1 hour
  dt: 0.2                     # Simulation time step (seconds)
  report_every: 300.0         # Reporting interval (seconds) - 5 minutes
  warmup_time: 600.0          # Warmup period before collecting metrics (10 min)
  
  sumo_gui: false
  step_length: 0.2
  lateral_resolution: 0.8

# --------------------------------------------------------------------------
# Geometry Parameters
# --------------------------------------------------------------------------
geometry:
  # Intersection dimensions
  approach_length: 200.0      # Length of approach roads (m)
  approach_lanes: 2           # Lanes per approach (1-3)
  lane_width: 3.5             # Lane width (m)
  
  # Turn pockets (optional)
  left_turn_lane: true        # Dedicated left turn lane
  right_turn_lane: false      # Dedicated right turn lane (usually shared)
  
  # Speed limits
  approach_speed: 13.89       # 50 km/h in m/s
  intersection_speed: 11.11   # 40 km/h in m/s

# --------------------------------------------------------------------------
# Traffic Demand (SAME as roundabout for comparison)
# --------------------------------------------------------------------------
demand:
  # Per-arm arrival rates (vehicles/second)
  # Arms: [North, East, South, West]
  arrivals: [0.18, 0.12, 0.20, 0.15]
  
  # Turning movement probabilities [Left, Through, Right]
  turning_probabilities: [0.25, 0.55, 0.20]
  
  # Vehicle type distribution
  vehicle_types:
    passenger: 0.85
    truck: 0.10
    bus: 0.05

# --------------------------------------------------------------------------
# Driver Behavior (SAME as roundabout)
# --------------------------------------------------------------------------
driver:
  accel: 1.5
  decel: 2.0
  emergency_decel: 4.5
  sigma: 0.5
  tau: 1.2
  min_gap: 2.0
  speed_factor: 1.0
  speed_dev: 0.1
  max_speed: 13.89            # 50 km/h

# --------------------------------------------------------------------------
# Signal Timing Parameters
# --------------------------------------------------------------------------
signal:
  # Webster's Method parameters
  webster:
    # Saturation flow (vehicles/hour/lane when continuously green)
    saturation_flow: 1800.0   # Typical value for urban arterials
    
    # Lost time per phase (seconds)
    startup_lost_time: 2.0    # Time lost at start of green
    clearance_lost_time: 2.0  # Yellow + all-red time
    
    # Phase configuration (4-phase: NS-Left, NS-Through, EW-Left, EW-Through)
    phases: 4
    
    # Minimum/maximum cycle times (seconds)
    min_cycle: 60.0
    max_cycle: 180.0
    
    # Yellow and all-red times (seconds)
    yellow_time: 3.0
    all_red_time: 2.0
  
  # PPO (Reinforcement Learning) parameters
  ppo:
    # Action space: adjustment to green times (seconds)
    min_green_time: 10.0      # Minimum green time for any phase
    max_green_time: 90.0      # Maximum green time for any phase
    green_adjustment: 5.0     # Discrete adjustment step (Â±5s)
    
    # State space features
    state_features:
      - queue_length          # Vehicles waiting per approach
      - waiting_time          # Average waiting time per approach
      - throughput            # Recent throughput per approach
      - phase_elapsed         # Time since phase started
      - time_of_day          # Cyclical encoding
    
    # Reward function weights
    reward_weights:
      throughput: 1.0         # Maximize throughput
      delay: -0.5             # Minimize delay
      queue: -0.3             # Minimize queue length
      stops: -0.1             # Minimize stops
      fairness: 0.2           # Balance service across approaches
    
    # Training parameters
    total_timesteps: 500000   # Total training steps
    learning_rate: 0.0003
    n_steps: 2048            # Steps per update
    batch_size: 64
    n_epochs: 10
    gamma: 0.99              # Discount factor
    gae_lambda: 0.95
    clip_range: 0.2
    ent_coef: 0.01           # Entropy coefficient for exploration

# --------------------------------------------------------------------------
# Parameter Sweep Ranges
# --------------------------------------------------------------------------
sweep:
  # Demand variations (multipliers on base arrivals)
  demand_multipliers: [0.5, 0.75, 1.0, 1.25, 1.5]
  
  # Signal control strategies
  control_strategies:
    - webster              # Fixed-time (Webster's Method)
    - ppo                  # Adaptive (PPO)
    - actuated            # Simple vehicle actuation (baseline)
  
  # Baseline scenario
  baseline:
    control: webster
    demand_multiplier: 1.0

# --------------------------------------------------------------------------
# Metrics Collection (SAME as roundabout for comparison)
# --------------------------------------------------------------------------
metrics:
  window_metrics:
    - arrivals
    - exits
    - throughput
    - avg_delay
    - p95_delay
    - max_queue_length
    - avg_speed
    - stops_per_vehicle
  
  aggregate_metrics:
    - total_arrivals
    - total_exits
    - mean_delay
    - p95_delay
    - max_queue_by_arm
    - throughput
    - avg_travel_time
    - avg_time_loss
  
  sumo_metrics:
    - co2_emission
    - fuel_consumption
    - nox_emission
    - noise_emission
    - waiting_time
    - time_loss

# --------------------------------------------------------------------------
# Failure Detection
# --------------------------------------------------------------------------
failure:
  throughput_plateau_threshold: 0.05
  queue_divergence_threshold: 50
  queue_growth_rate: 5
  max_acceptable_delay: 120.0
  max_acceptable_queue: 30

# --------------------------------------------------------------------------
# Output Settings
# --------------------------------------------------------------------------
output:
  results_dir: 'results'
  raw_data_dir: 'results/raw'
  plots_dir: 'results/plots'
  sumo_configs_dir: 'sumo_configs'
  models_dir: 'models'        # For saving trained PPO models
  
  data_format: 'csv'
  plot_formats: ['png', 'pdf']
  
  scenario_prefix: 'signal'
  timestamp_format: '%Y%m%d_%H%M%S'
